<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Recover Accidentally Removed DFS Namespace Links ¬∑ Windows Server Talks</title>
  <link rel="stylesheet" href="assets/css/custom.css">
  <script src="assets/js/site.js" defer></script>
</head>

<body>

<a class="skip-link" href="#main-content">Skip to content</a>

<header class="site-header">
  <div class="container">
    <h1>Windows Server Talks</h1>
    <p class="tagline">DFS, Active Directory, Hyper‚ÄëV, and PowerShell guides by Mohit Maurya</p>
  </div>
</header>

<nav class="breadcrumbs container" aria-label="Breadcrumb">
  <a href="index.html">Home</a>
  <span aria-hidden="true">‚Ä∫</span>
  <span aria-current="page">Recover Deleted DFS‚ÄëN Links</span>
</nav>

<div class="layout container">

  <!-- Sidebar -->
  <aside class="sidebar" aria-label="Primary">
    <h3>üìö Contents</h3>
    <ul>
      <li><a href="domain-based-dfs-n-auto-backup.html">DFS‚ÄëN Auto Backup</a></li>
      <li><a href="recover-deleted-dfs-n-links.html" class="active" aria-current="page">Recover Deleted DFS‚ÄëN Links</a></li>
      <li><a href="index.html">‚Üê Back to Home</a></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <main id="main-content" class="content" role="main">

    <h2>Recover Accidentally Removed Namespace Folder and Targets (AD Recycle Bin Enabled)</h2>

    <div class="card">
      <h3>Summary</h3>
      <p>
        This article provides a detailed guide on <strong>recovering accidentally deleted DFS namespace links
        and their targets</strong> using the <strong>Active Directory Recycle Bin</strong>.
        It covers discovery of deleted DFS objects, identification of the correct
        <strong>ObjectGUID</strong>, and restoration using PowerShell.
      </p>
      <p>
        The guide includes scripts to <strong>list deleted links</strong>, export results to
        <strong>CSV/TXT</strong>, and perform <strong>bulk restores</strong> with full logging
        for audit and validation purposes.
      </p>
    </div>

    <div class="card">
      <p><strong>Scope:</strong> Domain‚Äëbased DFS Namespaces (DFS‚ÄëN) on Windows Server,
      where <strong>Active Directory Recycle Bin</strong> is enabled.</p>

      <p><strong>Does not cover:</strong> DFS Replication (DFS‚ÄëR) data recovery
      or full namespace root restoration ‚Äî only DFS link objects and their target metadata.</p>
    </div>

    <h2>Step 1: Check if DFS Links Were Deleted</h2>

    <p>
      The following script searches for deleted <code>msDFS-Linkv2</code> objects,
      calculates deletion age, and exports results for review.
    </p>

    <div class="code-wrap">
      <button class="copy-btn">Copy</button>
      <pre><code>
Import-Module ActiveDirectory

# Define log folder
$LogFolder = "C:\DFSlogs"
if (!(Test-Path -Path $LogFolder)) {
    New-Item -Path $LogFolder -ItemType Directory | Out-Null
}

# Current date
$CurrentDate = Get-Date

# Query deleted DFS links
$DeletedDFSObjects = Get-ADObject `
  -Filter 'ObjectClass -eq "msDFS-Linkv2" -and isDeleted -eq $true' `
  -IncludeDeletedObjects `
  -Properties DistinguishedName, Name, ObjectClass, whenChanged, ObjectGUID

$Result = $DeletedDFSObjects | Select-Object `
  Name,
  ObjectClass,
  DistinguishedName,
  @{Name="ObjectGUID";Expression={$_.ObjectGUID}},
  @{Name="DeletedOn";Expression={($_.whenChanged).ToString("dd-MMM-yyyy HH:mm")}},
  @{Name="Age";Expression={
    if ($_.whenChanged) {
      $diff = $CurrentDate - $_.whenChanged
      if ($diff.Days -ge 1) { "$($diff.Days) days ago" }
      else { "$([math]::Round($diff.TotalHours,1)) hours ago" }
    } else { "N/A" }
  }}

# Export reports
$TxtFile = Join-Path $LogFolder "DFS_DeletedLinks_$(Get-Date -Format 'ddMMyyyy_HHmm').txt"
$Result | Format-Table -AutoSize | Out-String | Set-Content $TxtFile

$CsvFile = Join-Path $LogFolder "DFS_DeletedLinks_$(Get-Date -Format 'ddMMyyyy_HHmm').csv"
$Result | Export-Csv $CsvFile -NoTypeInformation
      </code></pre>
    </div>

    <p>
      Review the CSV file and remove rows you do not wish to restore
      (based on age or deletion date).
    </p>

    <h2>Understanding the Correct ObjectGUID</h2>

    <p>
      The GUID shown in the deleted DFS link name cannot be directly used for restore.
      You must retrieve the <strong>actual ObjectGUID</strong> from Active Directory.
    </p>

    <div class="code-wrap">
      <button class="copy-btn">Copy</button>
      <pre><code>
Get-ADObject -Filter 'isDeleted -eq $true' -IncludeDeletedObjects |
  Where-Object {
    $_.DistinguishedName -like "*3c61c2e5-d037-45f5-bb24-8907150a4fbc*"
  }
      </code></pre>
    </div>

    <p>
      The output will show the restored object with its true <code>ObjectGUID</code>,
      which is required for recovery.
    </p>

    <h2>Restore DFS Links (Bulk Automation)</h2>

    <div class="code-wrap">
      <button class="copy-btn">Copy</button>
      <pre><code>
Import-Module ActiveDirectory

$CsvFile = "C:\DFSlogs\DFS_DeletedLinks_29102025_0331.csv"
$LogFile = "C:\DFSlogs\RestoreLog_$(Get-Date -Format 'ddMMyyyy_HHmm').txt"

Set-Content -Path $LogFile -Value "DFS Restore Log - $(Get-Date)`r`n"

$Entries = Import-Csv -Path $CsvFile

foreach ($entry in $Entries) {
  $guid = $entry.ObjectGUID
  Add-Content -Path $LogFile -Value "Processing ObjectGUID: $guid"

  try {
    Restore-ADObject -Identity $guid
    Start-Sleep -Seconds 2

    $restoredObj = Get-ADObject -Filter { ObjectGUID -eq $guid } -ErrorAction SilentlyContinue
    if ($restoredObj) {
      Add-Content -Path $LogFile -Value "SUCCESS: Restored $guid"
    } else {
      Add-Content -Path $LogFile -Value "WARN: Object not found after restore: $guid"
    }
  }
  catch {
    Add-Content -Path $LogFile -Value "ERROR: Failed to restore $guid - $_"
  }
}

Write-Host "Restore process completed. Log saved to: $LogFile"
      </code></pre>
    </div>

    <div class="card">
      <p>
        ‚úÖ Successfully restored DFS links become immediately visible in DFS Management.<br>
        ‚úÖ Detailed restore logs are generated for auditing and troubleshooting.
      </p>
    </div>

  </main>
</div>

<footer class="site-footer">
  <div class="container">
    <p>¬© 2026 Mohit Maurya ¬∑ Windows Server Talks</p>
  </div>
</footer>

</body>
</html>
