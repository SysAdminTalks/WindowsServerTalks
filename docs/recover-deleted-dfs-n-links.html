<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recover Deleted DFS‚ÄëN Links ¬∑ Windows Server Talks</title>
  <link rel="stylesheet" href="assets/css/custom.css" />
  <script src="assets/js/site.js" defer></script>
</head>

<body>
  <a class="skip-link" href="#main-content">Skip to content</a>

  <header class="site-header">
    <div class="container">
      <h1>Windows Server Talks</h1>
      <p class="tagline">DFS, Active Directory, Hyper‚ÄëV, and PowerShell guides by Mohit Maurya</p>
    </div>
  </header>

  <!-- Breadcrumbs -->
  <nav class="breadcrumbs container" aria-label="Breadcrumb">
    <a href="index.html">Home</a>
    <span aria-hidden="true">‚Ä∫</span>
    <span aria-current="page">Recover Deleted DFS‚ÄëN Links</span>
  </nav>

  <div class="layout container">
    <nav class="sidebar" aria-label="Primary">
      <h3>üìö Contents</h3>
      <ul>
        <li><a href="domain-based-dfs-n-auto-backup.html">DFS‚ÄëN Auto Backup</a></li>
        <li><a href="recover-deleted-dfs-n-links.html">Recover Deleted DFS‚ÄëN Links</a></li>
        <li><a href="index.html">‚Üê Back to Home</a></li>
      </ul>
    </nav>

    <main id="main-content" class="content" role="main">
      <h2>Recover Deleted DFS‚ÄëN Links</h2>

      <div class="card">
        <h3>Summary</h3>
        <p>
          Discover and restore deleted <strong>DFS‚ÄëN link objects</strong> using Active Directory metadata (Recycle Bin).
          Includes discovery/reporting and bulk restore with logging.
        </p>
        <p><strong>Note:</strong> This recovers <em>links and targets</em>, not an entire namespace. Keep namespace backups for full restoration.</p>
      </div>

      <div class="card">
        <h3>Prerequisites</h3>
        <ul>
          <li>Active Directory Recycle Bin enabled</li>
          <li>RSAT / AD PowerShell module available</li>
          <li>Appropriate permissions to query deleted objects and restore</li>
        </ul>
      </div>

      <div class="card">
        <h3>Step 1 ‚Äî Discover Deleted DFS‚ÄëN Links</h3>
        <p>List deleted <code>msDFS-Linkv2</code> objects, export to TXT/CSV, and review before restore.</p>
      </div>

      <pre><code class="language-powershell">
Import-Module ActiveDirectory

$LogFolder = "C:\DFSlogs"
if (!(Test-Path -Path $LogFolder)) {
  New-Item -Path $LogFolder -ItemType Directory | Out-Null
}

$CurrentDate = Get-Date

$DeletedDFSObjects = Get-ADObject `
  -Filter 'ObjectClass -eq "msDFS-Linkv2" -and isDeleted -eq $true' `
  -IncludeDeletedObjects `
  -Properties DistinguishedName, Name, ObjectClass, whenChanged, ObjectGUID

$Result = $DeletedDFSObjects |
  Select-Object `
    Name, ObjectClass, DistinguishedName,
    @{Name="ObjectGUID"; Expression={$_.ObjectGUID}},
    @{Name="DeletedOn";  Expression={ ($_.whenChanged).ToString("dd-MMM-yyyy HH:mm") }},
    @{Name="Age";        Expression={
       if ($_.whenChanged) {
         $diff = $CurrentDate - $_.whenChanged
         if ($diff.Days -ge 1) { "$($diff.Days) days ago" }
         else { "$([math]::Round($diff.TotalHours,1)) hours ago" }
       } else { "N/A" }
    }}

$TxtFile = Join-Path $LogFolder "DFS_DeletedLinks_$(Get-Date -Format 'ddMMyyyy_HHmm').txt"
$Result | Format-Table -AutoSize | Out-String | Set-Content $TxtFile

$CsvFile = Join-Path $LogFolder "DFS_DeletedLinks_$(Get-Date -Format 'ddMMyyyy_HHmm').csv"
$Result | Export-Csv $CsvFile -NoTypeInformation

Write-Host "Reports saved to:`nTXT: $TxtFile`nCSV: $CsvFile"
      </code></pre>

      <div class="card">
        <h3>Step 2 ‚Äî Bulk Restore by ObjectGUID</h3>
        <p>Use the CSV from Step¬†1. Each row should contain a valid <code>ObjectGUID</code> to restore.</p>
      </div>

      <pre><code class="language-powershell">
Import-Module ActiveDirectory

$CsvFile = "C:\DFSlogs\DFS_DeletedLinks_29102025_0331.csv"
$LogFile = "C:\DFSlogs\RestoreLog_$(Get-Date -Format 'ddMMyyyy_HHmm').txt"

Set-Content -Path $LogFile -Value "DFS Restore Log - $(Get-Date)`r`n"

$Entries = Import-Csv -Path $CsvFile
foreach ($entry in $Entries) {
  $guid = $entry.ObjectGUID
  Add-Content -Path $LogFile -Value "Processing ObjectGUID: $guid"

  try {
    Restore-ADObject -Identity $guid
    Start-Sleep -Seconds 2

    $restoredObj = Get-ADObject -Filter { ObjectGUID -eq $guid } -ErrorAction SilentlyContinue
    if ($restoredObj) {
      Add-Content -Path $LogFile -Value "SUCCESS: Restored $guid"
    } else {
      Add-Content -Path $LogFile -Value "WARN: Attempted restore; object not found: $guid"
    }
  } catch {
    Add-Content -Path $LogFile -Value "ERROR: Failed to restore $guid - $_"
  }
}

Write-Host "Restore process completed. Log saved to: $LogFile"
      </code></pre>
    </main>
  </div>

  <footer class="site-footer">
    <div class="container">
      <p>¬© 2026 Mohit Maurya ¬∑ Windows Server Talks</p>
    </div>
  </footer>
</body>
</html>
